# 技術スタック選定（MVP）

## 目的

* Mastra を使った **日次ログサービス** を最短で立ち上げる
* セキュリティ事故（特に認可漏れ）を極力避ける
* 将来の拡張（週次/月次レポート、バックエンド分離）に耐えられる構成にする

---

## 採用技術スタック（結論）

* **フロントエンド / BFF**: Next.js（Vercel）
* **認証 / 認可**: Supabase Auth
* **データベース**: Supabase Postgres + Row Level Security（RLS）
* **AIエージェント**: Mastra（Next.js Route Handler 内で実行）
* **定期処理（将来）**: Vercel Cron（週次 / 月次レポート用）

※ メール配信は現時点では **TODO（後回し）** とする

---

## 選定理由

### 1. Next.js（Vercel）をバックエンド込みで使う理由

* **MVP を最短で作れる**

  * UI と API（Route Handler）を同一リポジトリ・同一デプロイで管理できる
  * CORS や認証トークンの受け渡しがシンプル
* Mastra の処理内容が軽量

  * ユーザー入力 → フォローアップ質問生成
  * 数秒以内に完結するため同期 API で問題ない

#### 注意点（対策前提）

* Middleware だけに認証・認可を依存しない
* **Route Handler 内で必ずユーザー検証を行う**（最終防衛は DB）

---

### 2. Supabase Auth + RLS を選んだ理由

* **認可ミスが起きても DB が止める設計ができる**

  * 日次ログは「他人のデータが見える」＝致命的
  * RLS により `auth.uid() = user_id` を DB レベルで強制
* Next.js 側の実装ミス・一時的な脆弱性があっても

  * **データ漏えいの確率を大きく下げられる**
* Auth + DB + 管理 UI が一体で提供されており

  * 初期構築が速い

---

### 3. Mastra を Next.js 内で動かす理由（現時点）

* 処理が軽量で同
